<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>避免浮点数的坐标点 | C.AI 的文档库</title>
    <meta name="description" content="前端工程师 C.AI 的文档库">
    <link rel="icon" href="/cyz.github.io/img/logo.ico">
    
    <link rel="preload" href="/cyz.github.io/assets/css/0.styles.25a0871d.css" as="style"><link rel="preload" href="/cyz.github.io/assets/js/app.82a6192d.js" as="script"><link rel="preload" href="/cyz.github.io/assets/js/22.34e5a93e.js" as="script"><link rel="prefetch" href="/cyz.github.io/assets/js/10.6b673105.js"><link rel="prefetch" href="/cyz.github.io/assets/js/11.f6d1773e.js"><link rel="prefetch" href="/cyz.github.io/assets/js/12.bd0963ae.js"><link rel="prefetch" href="/cyz.github.io/assets/js/13.4fb1e052.js"><link rel="prefetch" href="/cyz.github.io/assets/js/14.d4219c09.js"><link rel="prefetch" href="/cyz.github.io/assets/js/15.32e0872d.js"><link rel="prefetch" href="/cyz.github.io/assets/js/16.04d56c4b.js"><link rel="prefetch" href="/cyz.github.io/assets/js/17.acfaff2f.js"><link rel="prefetch" href="/cyz.github.io/assets/js/18.40ab7a5f.js"><link rel="prefetch" href="/cyz.github.io/assets/js/19.76a8d70f.js"><link rel="prefetch" href="/cyz.github.io/assets/js/2.8c7a069e.js"><link rel="prefetch" href="/cyz.github.io/assets/js/20.bfeb4387.js"><link rel="prefetch" href="/cyz.github.io/assets/js/21.7eec8ada.js"><link rel="prefetch" href="/cyz.github.io/assets/js/23.72ba34a3.js"><link rel="prefetch" href="/cyz.github.io/assets/js/24.6d05c45c.js"><link rel="prefetch" href="/cyz.github.io/assets/js/25.89042c01.js"><link rel="prefetch" href="/cyz.github.io/assets/js/26.68a65a7f.js"><link rel="prefetch" href="/cyz.github.io/assets/js/27.ab5b6838.js"><link rel="prefetch" href="/cyz.github.io/assets/js/28.f40bf167.js"><link rel="prefetch" href="/cyz.github.io/assets/js/29.87af6767.js"><link rel="prefetch" href="/cyz.github.io/assets/js/3.cd90806d.js"><link rel="prefetch" href="/cyz.github.io/assets/js/30.f4c61071.js"><link rel="prefetch" href="/cyz.github.io/assets/js/31.73e9ab21.js"><link rel="prefetch" href="/cyz.github.io/assets/js/32.a3f14af1.js"><link rel="prefetch" href="/cyz.github.io/assets/js/4.a5642797.js"><link rel="prefetch" href="/cyz.github.io/assets/js/5.83748181.js"><link rel="prefetch" href="/cyz.github.io/assets/js/6.db3efe01.js"><link rel="prefetch" href="/cyz.github.io/assets/js/7.7d435fcb.js"><link rel="prefetch" href="/cyz.github.io/assets/js/8.89e2316b.js"><link rel="prefetch" href="/cyz.github.io/assets/js/9.74c5292a.js">
    <link rel="stylesheet" href="/cyz.github.io/assets/css/0.styles.25a0871d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cyz.github.io/" class="home-link router-link-active"><!----> <span class="site-name">C.AI 的文档库</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/cyz.github.io/" class="nav-link">主页</a></div><div class="nav-item"><a href="/cyz.github.io/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JS相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/canvas/" class="nav-link router-link-active">Canvas</a></li><li class="dropdown-item"><!----> <a href="/cyz.github.io/JS/" class="nav-link">Javascript语法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">CSS相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/CSS/" class="nav-link">常用布局</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Vue相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/VUE/" class="nav-link">基础命令</a></li><li class="dropdown-item"><!----> <a href="/cyz.github.io/VueTree/" class="nav-link">技术栈</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/Applet/" class="nav-link">小程序</a></li><li class="dropdown-item"><!----> <a href="/cyz.github.io/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Fishcyz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/cyz.github.io/" class="nav-link">主页</a></div><div class="nav-item"><a href="/cyz.github.io/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JS相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/canvas/" class="nav-link router-link-active">Canvas</a></li><li class="dropdown-item"><!----> <a href="/cyz.github.io/JS/" class="nav-link">Javascript语法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">CSS相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/CSS/" class="nav-link">常用布局</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Vue相关</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/VUE/" class="nav-link">基础命令</a></li><li class="dropdown-item"><!----> <a href="/cyz.github.io/VueTree/" class="nav-link">技术栈</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cyz.github.io/Applet/" class="nav-link">小程序</a></li><li class="dropdown-item"><!----> <a href="/cyz.github.io/other/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Fishcyz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/cyz.github.io/canvas/" class="sidebar-link">canvas入门</a></li><li><a href="/cyz.github.io/canvas/RandomParticles.html" class="sidebar-link">实现随机粒子</a></li><li><a href="/cyz.github.io/canvas/RandomParticlesMove.html" class="sidebar-link">使你的随机粒子动起来</a></li><li><a href="/cyz.github.io/canvas/MouseScreen.html" class="sidebar-link">使你的鼠标和屏幕互动</a></li><li><a href="/cyz.github.io/canvas/Optimize.html" class="active sidebar-link">Canvas优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#避免浮点数的坐标点" class="sidebar-link">避免浮点数的坐标点</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#使用多层画布去画一个复杂的场景" class="sidebar-link">使用多层画布去画一个复杂的场景</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#用-css-transforms-特性缩放画布" class="sidebar-link">用 CSS transforms 特性缩放画布</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#离屏渲染" class="sidebar-link">离屏渲染</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#离屏渲染-2" class="sidebar-link">离屏渲染</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#round-item-方法" class="sidebar-link">Round_item 方法</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#this-cache-方法" class="sidebar-link">this.cache() 方法</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#draw-方法" class="sidebar-link">draw() 方法</a></li><li class="sidebar-sub-header"><a href="/cyz.github.io/canvas/Optimize.html#效果" class="sidebar-link">效果</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h2 id="避免浮点数的坐标点"><a href="#避免浮点数的坐标点" aria-hidden="true" class="header-anchor">#</a> 避免浮点数的坐标点</h2> <p>绘制图形时，长度与坐标应选取整数而不是浮点数，原因在于 <code>Canvas</code> 支持半个像素绘制。</p> <p>会根据小数位实现插值算法实现绘制图像的反锯齿效果，如果没有必要请不要选择浮点数值。</p> <h2 id="使用多层画布去画一个复杂的场景"><a href="#使用多层画布去画一个复杂的场景" aria-hidden="true" class="header-anchor">#</a> 使用多层画布去画一个复杂的场景</h2> <p>一般在游戏中这个优化方式会经常使用，但是在我们的背景特效中不经常使用，这个优化方式是将经常移动的元素和不经常移动的元素分层，避免不必要的重绘。</p> <p>比如在游戏中，背景不经常变换和人物这些经常变换的元素分成不同的层，这样需要重绘的资源就会少很多。</p> <h2 id="用-css-transforms-特性缩放画布"><a href="#用-css-transforms-特性缩放画布" aria-hidden="true" class="header-anchor">#</a> 用 CSS transforms 特性缩放画布</h2> <p>如果你使用 <code>left</code>、<code>top</code> 这些 css 属性来写动画的话，那么会触发整个像素渲染流程 <code>paint</code>, <code>layout</code> 和 <code>composition</code>。</p> <p>但是使用 <code>transforms</code> 中的 <code>translateX/Y</code> 来切换动画，你将会发现，这并不会触发 <code>paint</code>, <code>layout</code>，仅仅会触发 <code>composition</code> 的阶段。</p> <p>这是因为 <code>transforms</code> 调用的是 GPU 而不是 CPU。</p> <h2 id="离屏渲染"><a href="#离屏渲染" aria-hidden="true" class="header-anchor">#</a> 离屏渲染</h2> <p>名字听起来很复杂，什么离屏渲染，其实就是设置缓存，绘制图像的时候在屏幕之外的地方绘制好，然后再直接拿过来用，这不就是缓存的概念吗?</p> <p>建立两个 <code>canvas</code> 标签，大小一致，一个正常显示，一个隐藏（缓存用的，不插入 dom 中），先将结果 draw 缓存用的 canvas 上下文中，因为游离 canvas 不会造成ui的渲染，所以它不会展现出来，再把缓存的内容整个裁剪再 draw 到正常显示用的 canvas 上，这样能优化不少。</p> <h2 id="离屏渲染-2"><a href="#离屏渲染-2" aria-hidden="true" class="header-anchor">#</a> 离屏渲染</h2> <p>我们离屏渲染的主要过程就是将一个一个的粒子先在屏幕之外创建出来，然后再使用 <code>drawImage()</code> 方法将其“放入”到我们的主屏幕中。</p> <p>首先要在全局设置一个变量 <code>useCache</code> 来存放我们是否使用离屏渲染这种优化方式。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var useCache = true;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="round-item-方法"><a href="#round-item-方法" aria-hidden="true" class="header-anchor">#</a> Round_item 方法</h2> <p>在 Round_item 原型的 <code>draw()</code> 方法中来创建每一个离屏的小的 canvas。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>function Round_item(index, x, y) { 
    this.index = index; 
    this.x = x; 
    this.y = y; 
    this.useCache = useChache; 
    this.cacheCanvas = document.createElement(&quot;canvas&quot;); 
    this.cacheCtx = this.cacheCanvas.getContext(&quot;2d&quot;); 
    this.r = Math.random() * 2 + 1; 
    this.cacheCtx.width = 6 * this.r; 
    this.cacheCtx.height = 6 * this.r; 
    var alpha = (Math.floor(Math.random() * 10) + 1) / 10 / 2; 
    this.color = &quot;rgba(255,255,255,&quot; + alpha + &quot;)&quot;; 
    if(useChache){ 
        this.cache(); 
    } 
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="为什么我们这里的-cachecanvas-画布的宽度要设置为-6-倍的半径？"><a href="#为什么我们这里的-cachecanvas-画布的宽度要设置为-6-倍的半径？" aria-hidden="true" class="header-anchor">#</a> 为什么我们这里的 <code>cacheCanvas</code> 画布的宽度要设置为 6 倍的半径？</h4> <p>那是因为，我们创建的 <code>cacheCanvas</code> 不仅仅是有圆，还包括圆的阴影，所以我们要将 <code>cacheCanvas</code> 的面积设置的稍微大一些，这样才能将圆带阴影一起剪切到我们的主 Canvas 中。</p> <p>在 <code>draw()</code> 方法中，我们新创建了 <code>cacheCanvas</code>，并获取到了 <code>cacheCanvas</code> 的上下文环境，然后设置其宽高。</p> <p>然后我们判断了 <code>useChache</code> 变量的值，也就是说，如果我们将 <code>useChache</code> 设置为 <code>true</code>，也就是使用缓存，我们就调用 <code>this.cache()</code> 方法。</p> <h2 id="this-cache-方法"><a href="#this-cache-方法" aria-hidden="true" class="header-anchor">#</a> this.cache() 方法</h2> <p>在 <code>this.cache()</code> 方法中，我们的主要任务是在每一个 <code>cacheCanvas</code> 中都绘制一个圆。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Round_item.prototype.cache = function () { 
    this.cacheCtx.save(); 
    this.cacheCtx.fillStyle = this.color; 
    this.cacheCtx.shadowColor = &quot;white&quot;; 
    this.cacheCtx.shadowBlur = this.r * 2; 
    this.cacheCtx.beginPath(); 
    this.cacheCtx.arc(this.r * 3, this.r * 3, this.r, 0, 2 * Math.PI); 
    this.cacheCtx.closePath(); 
    this.cacheCtx.fill(); 
    this.cacheCtx.restore(); 
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>和在 <code>draw()</code> 方法中画的圆不同之处是，要注意这里设置的圆心坐标，是 <code>this.r * 3</code>，因为我们创建的 <code>cacheCanvas</code> 的宽度和高度都是 <code>6 * this.r</code>，我们的圆是要显示在 <code>cacheCanvas</code> 的正中心，所以设置圆心的坐标应该是 <code>this.r * 3,this.r * 3</code>。</p> <h2 id="draw-方法"><a href="#draw-方法" aria-hidden="true" class="header-anchor">#</a> draw() 方法</h2> <p>既然设置了 <code>cacheCanvas</code>，那么我们在 <code>draw()</code> 中，就需要使用 <code>Canvas</code> 的 <code>drawImage</code> 方法将 <code>cacheCanvas</code> 中的你内容显示在屏幕上。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Round_item.prototype.draw = function () { 
    if( !useChache){ 
        content.fillStyle = this.color; 
        content.shadowBlur = this.r * 2; 
        content.beginPath(); 
        content.arc(this.x, this.y, this.r, 0, 2 * Math.PI, false); 
        content.closePath(); 
        content.fill(); 
    }else{ 
        content.drawImage(this.cacheCanvas, this.x - this.r, this.y - this.r); 
    } 
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这里也是要判断下，如果没有使用缓存的话，还是使用最原始的创建圆的方式。</p> <h2 id="效果"><a href="#效果" aria-hidden="true" class="header-anchor">#</a> 效果</h2> <p><a href="https://codepen.io/fishcyz/full/RvYZVY" target="_blank" rel="noopener noreferrer">优化效果<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/14/2019, 5:17:56 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/cyz.github.io/canvas/MouseScreen.html" class="prev">
          使你的鼠标和屏幕互动
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/cyz.github.io/assets/js/app.82a6192d.js" defer></script><script src="/cyz.github.io/assets/js/22.34e5a93e.js" defer></script>
  </body>
</html>
